---
id: 222
title: 'Using PsTools in a pentest'
date: '2009-03-31T13:47:39-05:00'
author: 'Ron Bowes'
layout: revision
guid: 'http://www.skullsecurity.org/blog/?p=222'
permalink: '/?p=222'
---

I'm going to start off this blog by wishing a happy birthday to a very important person -- me. :)

Now, onto the content!

PsTools is a suite of tools developed by Sysinternals (now Microsoft). They're a great complement to any pen test, and many of my Nmap scripts are loosely based on them. As good as they are, they aren't without their quirks!

Here are a few topics to talk about:

- Ports and traffic
- Specifying an account
- Running it purely in a console

Most (possibly all) of the PsTools use standard Windows functions. That makes life easy -- we can expect PsTools to act the same way other remote functions work. If we know how!

## Ports and traffic

To me, understanding the traffic is the most important part of using a tool. And it's especially important if you're creating a netcat tunnel or something.

Since PsTools uses standard Windows functions, we can expect it to use port 445 for all traffic. The majority of them use that port and nothing else. Simple stuff!

Although PsTools are closed source, I've implemented similar functionality in many of my Nmap scripts. Have a look at the smb-\* scripts (included with Nmap 4.85beta4 and higher) if you want to understand the traffic more.

## Specifying an account

By default, PsTools will use your current account. That's useful on a pentest -- if you exploit a system, take access, and run PsTools, you're effectively getting access to every system with the same password!

You can try this by setting up two boxes with the same username/password, logging into one, and running the following command:

```
PsInfo.exe \a.b.c.d
```

If you want to use a specific account, you can normally pass -u and -p parameters (for username and password). I seem to recall, however, that not all PsTools apps take those parameters (although I tested a couple quickly and they all did, so maybe I'm lying?)

In any case, you can get around this issue by first establishing a session with the machine using the following command:

```
net use \a.b.c.d
```

You'll be prompted for a username and password.

Then run it as usual:

```
PsInfo.exe \a.b.c.d
```

And it'll use the account (and, in fact, the same TCP session) you already established. When you want to terminate the session, delete it with:

```
net use \a.b.c.d /del
```

Finally, passing the hash with PsTools. Because PsTools uses Windows' implementation of SMB, it has to use Windows' authentication routines. For some reason, Microsoft didn't want people passing the hash, so that means passing the hash natively is impossible.

Fortunately, the good folks at Core Security released a tool called the Pass the Hash Toolkit. It contains a program called "iam.exe", which will replace your username/hash with an arbitrary username/hash. Then, when you try to log in, it'll use the alternate hash instead of your own!

Let's look at an example (I've removed the ends of the hashes):

```
C:>iam.exe -B -h administrator:domain:293b2c[...]:c35f1c[...]
```

This will save the given username and hashes over the current one. When you use the PsTools programs now, they'll connect with the given username and hash.

```
PsInfo.exe \a.b.c.d
```

## Running purely in a console

Finally, this is the most annoying part about PsTools -- the first time you run it on a particular system, a graphical box with the EULA comes up. While it's great, and you should understand the EULA, it's incredibly inconvenient when you're trying to be discreet. For that reason, I put together a .bat file that'll automatically agree to the EULA for all PsTools programs.

Note that by running this file, you are implicitly agreeing to the EULA for PsTools. You should only use this if you're trying to run the tools in console-only mode.  
**eulas.bat**

```
@echo off

rem Turns off the registration agreements for the PsTools programs, so they can be used in
rem a pen-test without popping up on the user.
rem
rem Naturally, you should familiarize yourself witht he EULAs before doing this.

echo Trying to import...
echo Running: regedit /s eulas.reg
regedit /s eulas.reg
```

You'll also need **eulas.reg**

```
Windows Registry Editor Version 5.00

[HKEY_CURRENT_USERSoftwareSysinternals]

[HKEY_CURRENT_USERSoftwareSysinternalsloggedon]
"EulaAccepted"=dword:00000001

[HKEY_CURRENT_USERSoftwareSysinternalsPsexec]
"EulaAccepted"=dword:00000001

[HKEY_CURRENT_USERSoftwareSysinternalspsfile]
"EulaAccepted"=dword:00000001

[HKEY_CURRENT_USERSoftwareSysinternalsPsGetSid]
"EulaAccepted"=dword:00000001

[HKEY_CURRENT_USERSoftwareSysinternalsPsInfo]
"EulaAccepted"=dword:00000001

[HKEY_CURRENT_USERSoftwareSysinternalsPsKill]
"EulaAccepted"=dword:00000001

[HKEY_CURRENT_USERSoftwareSysinternalsPsList]
"EulaAccepted"=dword:00000001

[HKEY_CURRENT_USERSoftwareSysinternalsPsLoglist]
"EulaAccepted"=dword:00000001

[HKEY_CURRENT_USERSoftwareSysinternalsPsPasswd]
"EulaAccepted"=dword:00000001

[HKEY_CURRENT_USERSoftwareSysinternalsPsService]
"EulaAccepted"=dword:00000001

[HKEY_CURRENT_USERSoftwareSysinternalsPsShutdown]
"EulaAccepted"=dword:00000001

[HKEY_CURRENT_USERSoftwareSysinternalsPsSuspend]
"EulaAccepted"=dword:00000001
```

Put that .bat and .reg file in the same folder, run the .bat file on the commandline, then go about your pentest without worrying about the user getting a PsTools popup on their machine.
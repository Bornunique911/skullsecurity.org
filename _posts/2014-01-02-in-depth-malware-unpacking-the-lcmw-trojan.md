---
id: 1719
title: 'In-depth malware: Unpacking the &#8216;lcmw&#8217; Trojan'
date: '2014-01-02T12:20:49-05:00'
author: ron
layout: post
guid: 'http://blog.skullsecurity.org/?p=1719'
permalink: /2014/in-depth-malware-unpacking-the-lcmw-trojan
categories:
    - Malware
    - 'Reverse Engineering'
---

Hey folks,

Happy New Year, and welcome to 2014!

On a recent trip to Tyson's Corner, VA, I had some time to kill, so I took a careful look at a malware sample that <a href='https://twitter.com/pontobunce'>a friend of mine sent</a> to me some time ago, which I believe he originally got off somebody else's hosed system. The plan was for me to investigate it, and I promised him I would; it just took awhile!

Anyways, the sample has a few layers of packing, and I thought it'd be fun/interesting to show you how to unwrap the entire thing to obtain the final payload. I am <em>not</em> going to discuss the payload itself in this post, largely because I haven't spent much time reversing it. Perhaps in the future I'll dig a little deeper, but for now we'll focus on the packing.

I called this sample "lcmw". It stood for something interesting, but I don't really remember what&mdash;I may have been drinking when I named it. :)
<!--more-->

You can find my IDA .idb files and my notes on <a href='https://github.com/iagox86/lcmw-analysis'>Github</a>, and samples on my <a href='http://downloads.skullsecurity.org/MALWARE/lcmw.zip'>downloads</a> page. WARNING: This is malware! Only run it in a highly controlled environment!! I <em>don't know what the final payload does</em>, so if you run it, it's at your own risk! Use a virtual machine, don't connect it to the Internet, etc. Be careful!

(The password is 'infected')

Fun fact: my ISP got an abuse@ email because I was originally hosting the malware file without putting it in a .zip file:

<pre>Dear abuse team,

please help to close these offending viruses sites(1) so far.

status: As of 2013-11-29 12:51:30 CET
[2]http://support.clean-mx.de/clean-mx/viruses.php?email=internet.abuse@noc.vo[..]

(for full uri, please scroll to the right end ...

We detected many active cases dated back to 2007, so please look at the date
column below.
You may also subscribe to our MalwareWatch list
[3]http://lists.clean-mx.com/cgi-bin/mailman/listinfo/viruswatch

This information has been generated out of our comprehensive real time
database,
tracking worldwide viruses URI's

If your review this list of offending site, please do this carefully, pay
attention for redirects also!
Also, please consider this particular machines may have a root kit installed !
So simply deleting some files or dirs or disabling cgi may not really solve
the
issue !
</pre>

That was neat. Thanks to my ISP&mdash;<a href='http://voinetworksolutions.com/home/'>Voi Network Solutions</a>&mdash;laughing about it with me rather than shutting off my connection!

<h2>Background</h2>

<h2>Stage1: the time waster</h2>

All right, if you're following along, this file is called "sample.bin". The original name was "hlcumrpi.dat". But if you run "file" on it (on *nix or Cygwin):

$ file hlcumrpi.dat
hlcumrpi.dat: PE32 executable (DLL) (GUI) Intel 80386, for MS Windows

It's technically a .dll library, and is typically run with a "rundll32.exe" command on startup. I renamed it to "sample.bin", since it's easier to remember that way. Fire up IDA, load the file, and have a look at the DllEntryPoint function!

<h3>Initial inspection</h3>

...are you done? Did you get lost in a deep rats' nest of functions? Because that's what this stage is all about&mdash;wasting your time. It turns out, there's maybe 10 lines that do <em>anything</em>&mdash;the rest just burns CPU and, more importantly, reverse engineer cycles.

Take this sequence for example:

<pre>
<span class="Statement">.text</span>:<span class="Constant">004014AE</span> <span class="Identifier">mov</span> <span class="Identifier">ebx</span>, 0<span class="Identifier">FFFFFh</span>
<span class="Statement">.text</span>:<span class="Constant">004014B3</span>
<span class="Statement">.text</span>:<span class="Constant">004014B3</span> <span class="Identifier">loc_4014B3</span>: <span class="Comment">; CODE XREF: DllEntryPoint+11j</span>
<span class="Statement">.text</span>:<span class="Constant">004014B3</span> <span class="Identifier">call</span> <span class="Identifier">UselessComplicatedFunction</span> <span class="Comment">; &lt;-- call this about a million times</span>
<span class="Statement">.text</span>:<span class="Constant">004014B3</span> <span class="Comment">; Honestly, I suspect this is a whole lot of nothing that's done to waste time</span>
<span class="Statement">.text</span>:<span class="Constant">004014B8</span> <span class="Identifier">dec</span> <span class="Identifier">ebx</span>
<span class="Statement">.text</span>:<span class="Constant">004014B9</span> <span class="Identifier">cmp</span> <span class="Identifier">ebx</span>, <span class="Constant">43</span><span class="Identifier">h</span>
<span class="Statement">.text</span>:<span class="Constant">004014BC</span> <span class="Identifier">jnz</span> <span class="Identifier">short</span> <span class="Identifier">loc_4014B3</span>
</pre>

I went through that entire function, and determined:
<ul>
  <li>There are no inputs</li>
  <li>Nothing is returned</li>
  <li>No global variables are touched</li>
  <li>No API calls are made</li>
</ul>

Basically, it does nothing. But it does it with <em>a lot</em> of code!

Then it gets the string length of the main function, which doesn't even make any sense, and ignores the response:

<pre>
<span class="Statement">.text</span>:<span class="Constant">004014C3</span> <span class="Identifier">call</span> <span class="Identifier">ds</span>:<span class="Identifier">lstrlenA</span> <span class="Comment">; &lt;-- get the strlen() of main(), which should be ignored</span>
</pre>

Then it gets the current process id about a million times:

<pre>
<span class="Statement">.text</span>:<span class="Constant">004014C9</span> <span class="Identifier">mov</span> <span class="Identifier">ebx</span>, <span class="Identifier">0FFFFFFh</span>
<span class="Statement">.text</span>:<span class="Constant">004014CE</span>
<span class="Statement">.text</span>:<span class="Constant">004014CE</span> <span class="Identifier">loc_4014CE</span>: <span class="Comment">; CODE XREF: DllEntryPoint+2Cj</span>
<span class="Statement">.text</span>:<span class="Constant">004014CE</span> <span class="Identifier">call</span> <span class="Identifier">GetCurrentProcessIdWrapper</span> <span class="Comment">; Call GetCurrentProcessId about a sixteen million times</span>
<span class="Statement">.text</span>:<span class="Constant">004014D3</span> <span class="Identifier">dec</span> <span class="Identifier">ebx</span>
<span class="Statement">.text</span>:<span class="Constant">004014D4</span> <span class="Identifier">cmp</span> <span class="Identifier">ebx</span>, <span class="Constant">43</span><span class="Identifier">h</span>
<span class="Statement">.text</span>:<span class="Constant">004014D7</span> <span class="Identifier">jnz</span> <span class="Identifier">short</span> <span class="Identifier">loc_4014CE</span>
</pre>

This function has no side effects and the return value is ignored. Once again, wasting time.

Then, we finally get to something interesting! This code:

<pre>
<span class="Statement">.text</span>:<span class="Constant">004014D9</span> <span class="Identifier">push</span> <span class="Identifier">PAGE_EXECUTE_READWRITE</span> <span class="Comment">; flProtect</span>
<span class="Statement">.text</span>:<span class="Constant">004014DB</span> <span class="Identifier">push</span> <span class="Constant">3000</span><span class="Identifier">h</span> <span class="Comment">; flAllocationType = MEM_COMMIT | MEM_RESERVE</span>
<span class="Statement">.text</span>:<span class="Constant">004014E0</span> <span class="Identifier">push</span> <span class="Constant">30AD8h</span> <span class="Comment">; dwSize</span>
<span class="Statement">.text</span>:<span class="Constant">004014E5</span> <span class="Identifier">push</span> <span class="Constant">0 </span><span class="Comment">; lpAddress</span>
<span class="Statement">.text</span>:<span class="Constant">004014E7</span> <span class="Identifier">call</span> <span class="Identifier">ds</span>:<span class="Identifier">VirtualAlloc</span> <span class="Comment">; Allocate memory to store the decrypted code</span>
<span class="Statement">.text</span>:<span class="Constant">004014ED</span> <span class="Identifier">mov</span> <span class="Identifier">edx</span>, <span class="Identifier">eax</span>
<span class="Statement">.text</span>:<span class="Constant">004014EF</span> <span class="Identifier">mov</span> <span class="Identifier">edi</span>, <span class="Identifier">eax</span> <span class="Comment">; edi =&gt; destination memory</span>
</pre>

Allocates 0x30ad8 bytes of read/write/execute memory, and stores the pointer to the memory in edi. 

Even though malware is malware&mdash;and you can never realllllly be sure why it's doing something&mdash;allocating a very specific amount of r/w/x memory almost always means one thing&mdash;it's going to unpack something into that buffer and then execute it.

And sure enough, that piece of code is followed by a de-obfuscation loop (I originally called it a "decryption loop", but that was technically wrong since it isn't actually decrypting anything):

<pre>
<span class="Statement">.text</span>:<span class="Constant">004014F6</span> <span class="Identifier">decrypt_loop</span>: <span class="Comment">; CODE XREF: DllEntryPoint+6Dj</span>
<span class="Statement">.text</span>:<span class="Constant">004014F1</span> <span class="Identifier">mov</span> <span class="Identifier">esi</span>, <span class="Identifier">offset</span> <span class="Identifier">start_encrypted_code</span>
<span class="Statement">.text</span>:<span class="Constant">004014F6</span> <span class="Identifier">call</span> <span class="Identifier">XorAndRotate</span> <span class="Comment">; eax = the next 4 non-NULL bytes in esi, each XORed by ebx (0x43?)</span>
<span class="Statement">.text</span>:<span class="Constant">004014FB</span> <span class="Identifier">shl</span> <span class="Identifier">al</span>, <span class="Constant">2</span>
<span class="Statement">.text</span>:<span class="Constant">004014FE</span> <span class="Identifier">shr</span> <span class="Identifier">ax</span>, <span class="Constant">2</span>
<span class="Statement">.text</span>:<span class="Constant">00401502</span> <span class="Identifier">stosb</span>
<span class="Statement">.text</span>:<span class="Constant">00401503</span> <span class="Identifier">shl</span> <span class="Identifier">ah</span>, <span class="Constant">4</span>
<span class="Statement">.text</span>:<span class="Constant">00401506</span> <span class="Identifier">shr</span> <span class="Identifier">eax</span>, <span class="Constant">8</span>
<span class="Statement">.text</span>:<span class="Constant">00401509</span> <span class="Identifier">shl</span> <span class="Identifier">ax</span>, <span class="Constant">2</span>
<span class="Statement">.text</span>:<span class="Constant">0040150D</span> <span class="Identifier">shr</span> <span class="Identifier">eax</span>, <span class="Constant">6</span>
<span class="Statement">.text</span>:<span class="Constant">00401510</span> <span class="Identifier">stosw</span>
<span class="Statement">.text</span>:<span class="Constant">00401512</span> <span class="Identifier">cmp</span> <span class="Identifier">esi</span>, <span class="Identifier">offset</span> <span class="Identifier">end_encrypted_data</span>
<span class="Statement">.text</span>:<span class="Constant">00401518</span> <span class="Identifier">jbe</span> <span class="Identifier">short</span> <span class="Identifier">decrypt_loop</span>
</pre>

Feel free to look at the function I called XorAndRotate&mdash;it's pretty boring. It just twiddles the current uint32 a bit.

You'll notice that esi&mdash;typically the "source" pointer&mdash;is initialized to something I called start_encrypted_code. I'm using the term "encrypted" in only the most general sense; "obfuscated" would have been better, but it's harder to type. If you dig deeper, this is what it looks like:

<pre>
<span class="Statement">.text</span>:<span class="Constant">00401549</span> <span class="Identifier">start_encrypted_code</span> <span class="Identifier">db</span> 0<span class="Identifier">D6h</span>, 0<span class="Identifier">E6h</span>, <span class="Constant">1</span><span class="Identifier">Bh</span>, <span class="Constant">0B</span><span class="Identifier">Ah</span>, 0<span class="Identifier">C0h</span>, 0<span class="Identifier">F1h</span>, 0<span class="Identifier">CDh</span>, 0<span class="Identifier">C2h</span>, <span class="Constant">0,</span> 0<span class="Identifier">D5h</span>
<span class="Statement">.text</span>:<span class="Constant">00401549</span> <span class="Comment">; DATA XREF: DllEntryPoint+46o</span>
<span class="Statement">.text</span>:<span class="Constant">00401549</span> <span class="Identifier">db</span> <span class="Constant">5</span><span class="Identifier">Eh</span>, <span class="Constant">0B</span><span class="Constant">6</span><span class="Identifier">h</span>, <span class="Constant">97</span><span class="Identifier">h</span>, 0<span class="Identifier">EBh</span>, 0<span class="Identifier">C0h</span>
<span class="Statement">.text</span>:<span class="Constant">00401558</span> <span class="Identifier">dd</span> <span class="Constant">2</span> <span class="Identifier">dup</span>(<span class="Constant">83008300</span><span class="Identifier">h</span>), 0<span class="Identifier">C2D50033h</span>, <span class="Constant">53</span><span class="Identifier">C02D2Dh</span>, 0<span class="Identifier">C7008300h</span>
<span class="Statement">.text</span>:<span class="Constant">00401558</span> <span class="Identifier">dd</span> <span class="Constant">6</span><span class="Identifier">A78300h</span>, <span class="Constant">83000</span><span class="Identifier">F49h</span>, <span class="Constant">83008300</span><span class="Identifier">h</span>, <span class="Constant">81</span><span class="Identifier">C88300h</span>, 0<span class="Identifier">C8C0C700h</span>
<span class="Statement">.text</span>:<span class="Constant">00401558</span> <span class="Identifier">dd</span> <span class="Constant">4</span><span class="Identifier">C70081h</span>, <span class="Constant">810481</span><span class="Identifier">C8h</span>, <span class="Constant">4</span><span class="Identifier">E18300h</span>, <span class="Constant">8</span><span class="Identifier">B6F1B04h</span>, 0<span class="Identifier">D6B68300h</span>
<span class="Statement">.text</span>:<span class="Constant">00401558</span> <span class="Identifier">dd</span> <span class="Constant">8</span><span class="Identifier">CB98Ch</span>, <span class="Constant">830083</span><span class="Identifier">h</span>, <span class="Constant">1</span><span class="Identifier">F830083h</span>, 0<span class="Identifier">C2B79A97h</span>, <span class="Constant">6</span><span class="Identifier">C001FE6h</span>
<span class="Statement">.text</span>:<span class="Constant">00401558</span> <span class="Identifier">dd</span> <span class="Constant">53</span><span class="Identifier">D5004Eh</span>, <span class="Constant">1</span><span class="Identifier">F2512A7h</span>, <span class="Constant">1</span><span class="Identifier">FB44EE6h</span>, <span class="Constant">61</span><span class="Identifier">B8300h</span>, <span class="Constant">681</span><span class="Identifier">B9h</span>, <span class="Constant">830083</span><span class="Identifier">h</span>
[...]
</pre>

And so on, for a long, long time. Almost certainly obfuscated code. And since it's being sent through that de-obfuscation function, that pretty much confirms it.

The function ends with:
<pre>
<span class="Statement">.text</span>:<span class="Constant">0040151A</span> <span class="Identifier">pop</span> <span class="Identifier">ebx</span>
<span class="Statement">.text</span>:<span class="Constant">0040151B</span> <span class="Identifier">pop</span> <span class="Identifier">edi</span>
<span class="Statement">.text</span>:<span class="Constant">0040151C</span> <span class="Identifier">pop</span> <span class="Identifier">esi</span>
<span class="Statement">.text</span>:<span class="Constant">0040151D</span> <span class="Identifier">jmp</span> <span class="Identifier">edx</span>
</pre>

Where edx&mdash;at that point&mdash;contains a pointer to the decrypted buffer.

So, we see a function that:
<ul>
<li>Wastes a ton of time</li>
<li>Allocated executable memory</li>
<li>Populates the executable memory</li>
<li>Jumps to the executable memory</li>
</ul>

A classic decryption/deobfuscation loop!

Let's look at the easiest possible way to own it!

<h3>Owning stage1</h3>

So, I'm lazy. Really lazy. I'm gonna find the easiest possible way to decrypt this bad boy.

WARNING: I run malware in this section. It's de-clawed, but you never know what clever tricks are used (I used to have a cat that was de-clawed, and believe me: they still have sharp teeth!); only do this in a throw-away virtual machine! Never, NEVER run this on any important system!

All right, so we have a useless function at the top (I enabled the 'code bytes' now so we can see what the machine code looks like):

<pre>
<span class="Statement">.text</span>:<span class="Constant">004014B3</span> <span class="Identifier">E8</span> <span class="Identifier">C0</span> <span class="Identifier">FE</span> <span class="Identifier">FF</span> <span class="Identifier">FF</span> <span class="Identifier">call</span> <span class="Identifier">UselessComplicatedFunction</span> <span class="Comment">; &lt;-- call this about a million times</span>
<span class="Statement">.text</span>:<span class="Constant">004014B3</span> <span class="Comment">; Honestly, I suspect this is a whole lot of nothing that's done to waste time</span>
<span class="Statement">.text</span>:<span class="Constant">004014B8</span> <span class="Constant">4</span><span class="Identifier">B</span> <span class="Identifier">dec</span> <span class="Identifier">ebx</span>
<span class="Statement">.text</span>:<span class="Constant">004014B9</span> <span class="Constant">83</span> <span class="Identifier">FB</span> <span class="Constant">43</span>
</pre>

I'm paranoid; mayyybe it's doing something important? So I'm gonna fire up a hex editor (like xvi32), search the sample.dll binary for the machine code, "<tt>e8 c0 fe ff ff 4b 83 fb 43</tt>" (which should be at offset 0x8b3 in the file), and nop out the call ("<tt>e8 c0 fe ff ff</tt>" -> "<tt>90 90 90 90 90</tt>").

That way, even if it <em>is</em> doing something sneaky, it's never called anyways.

Next, I'm going to do the same to the GetProcessId wrapper:

<pre>
<span class="Statement">.text</span>:<span class="Constant">004014CE</span> <span class="Identifier">E8</span> <span class="Identifier">D1</span> <span class="Identifier">FF</span> <span class="Identifier">FF</span> <span class="Identifier">FF</span> <span class="Identifier">call</span> <span class="Identifier">GetCurrentProcessIdWrapper</span> <span class="Comment">; Call GetCurrentProcessId about a sixteen million times</span>
<span class="Statement">.text</span>:<span class="Constant">004014D3</span> <span class="Constant">4</span><span class="Identifier">B</span> <span class="Identifier">dec</span> <span class="Identifier">ebx</span>
<span class="Statement">.text</span>:<span class="Constant">004014D4</span> <span class="Constant">83</span> <span class="Identifier">FB</span> <span class="Constant">43</span> <span class="Identifier">cmp</span> <span class="Identifier">ebx</span>, <span class="Constant">43</span><span class="Identifier">h</span>
</pre>

The 'call' instruction, which you can find at offset 0x8ce in the file, also needs to be replaced with "<tt>90 90 90 90 90</tt>".

Finally, we don't want the malware to actually <em>run</em>. That would defeat the entire purpose of de-clawing! So we find the code at the bottom:

<pre>
<span class="Statement">.text</span>:<span class="Constant">00401518</span> <span class="Constant">76</span> <span class="Identifier">DC</span> <span class="Identifier">jbe</span> <span class="Identifier">short</span> <span class="Identifier">decrypt_loop</span>
<span class="Statement">.text</span>:<span class="Constant">0040151A</span> <span class="Constant">5</span><span class="Identifier">B</span> <span class="Identifier">pop</span> <span class="Identifier">ebx</span>
<span class="Statement">.text</span>:<span class="Constant">0040151B</span> <span class="Constant">5</span><span class="Identifier">F</span> <span class="Identifier">pop</span> <span class="Identifier">edi</span>
<span class="Statement">.text</span>:<span class="Constant">0040151C</span> <span class="Constant">5</span><span class="Identifier">E</span> <span class="Identifier">pop</span> <span class="Identifier">esi</span>
<span class="Statement">.text</span>:<span class="Constant">0040151D</span> <span class="Identifier">FF</span> <span class="Identifier">E2</span> <span class="Identifier">jmp</span> <span class="Identifier">edx</span>
<span class="Statement">.text</span>:<span class="Constant">0040151D</span> <span class="Identifier">DllEntryPoint</span> <span class="Identifier">endp</span>
<span class="Statement">.text</span>:<span class="Constant">0040151D</span>
<span class="Statement">.text</span>:<span class="Constant">0040151F</span> <span class="Comment">; ---------------------------------------------------------------------------</span>
<span class="Statement">.text</span>:<span class="Constant">0040151F</span> <span class="Identifier">C3</span> <span class="Identifier">retn</span>
</pre>

We want to find the jmp instruction ("<tt>ff e2</tt>")&mdash;which should be at 0x91d in the file&mdash;and replace it with "<tt>cd 03</tt>".

Wait, what's <tt>cd 03</tt>!?

It's "<tt>int 3</tt>". Besides being my license plate, it's also the instruction that means "debug breakpoint". In other words, if a running application hits that instruction, it'll fire a debug interrupt. If the application is being debugged, the debugger gets control; if it's not, the application will simply crash. Whatever the case: it will <em>never</em> run the malicious code!

Save the new .dll&mdash;you can find this in the .zip under the name "sample_safe.bin"&mdash;and load it in IDA just to make sure. It should now look like this&mdash;note that there's only the one call left:

<pre>
<span class="Statement">.text</span>:<span class="Constant">004014AB</span> <span class="Identifier">DllEntryPoint</span> <span class="Identifier">proc</span> <span class="Identifier">near</span> <span class="Comment">; DATA XREF: DllEntryPoint+13o</span>
<span class="Statement">.text</span>:<span class="Constant">004014AB</span>
<span class="Statement">.text</span>:<span class="Constant">004014AB</span> <span class="Identifier">hinstDLL</span> = <span class="Identifier">dword</span> <span class="Identifier">ptr</span> <span class="Constant">4</span>
<span class="Statement">.text</span>:<span class="Constant">004014AB</span> <span class="Identifier">fdwReason</span> = <span class="Identifier">dword</span> <span class="Identifier">ptr</span> <span class="Constant">8</span>
<span class="Statement">.text</span>:<span class="Constant">004014AB</span> <span class="Identifier">lpReserved</span> = <span class="Identifier">dword</span> <span class="Identifier">ptr</span> 0<span class="Identifier">Ch</span>
<span class="Statement">.text</span>:<span class="Constant">004014AB</span>
<span class="Statement">.text</span>:<span class="Constant">004014AB</span> <span class="Identifier">push</span> <span class="Identifier">esi</span>
<span class="Statement">.text</span>:<span class="Constant">004014AC</span> <span class="Identifier">push</span> <span class="Identifier">edi</span>
<span class="Statement">.text</span>:<span class="Constant">004014AD</span> <span class="Identifier">push</span> <span class="Identifier">ebx</span>
<span class="Statement">.text</span>:<span class="Constant">004014AE</span> <span class="Identifier">mov</span> <span class="Identifier">ebx</span>, 0<span class="Identifier">FFFFFh</span>
<span class="Statement">.text</span>:<span class="Constant">004014B3</span>
<span class="Statement">.text</span>:<span class="Constant">004014B3</span> <span class="Identifier">loc_4014B3</span>: <span class="Comment">; CODE XREF: DllEntryPoint+11j</span>
<span class="Statement">.text</span>:<span class="Constant">004014B3</span> <span class="Identifier">nop</span>
<span class="Statement">.text</span>:<span class="Constant">004014B4</span> <span class="Identifier">nop</span>
<span class="Statement">.text</span>:<span class="Constant">004014B5</span> <span class="Identifier">nop</span>
<span class="Statement">.text</span>:<span class="Constant">004014B6</span> <span class="Identifier">nop</span>
<span class="Statement">.text</span>:<span class="Constant">004014B7</span> <span class="Identifier">nop</span>
<span class="Statement">.text</span>:<span class="Constant">004014B8</span> <span class="Identifier">dec</span> <span class="Identifier">ebx</span>
<span class="Statement">.text</span>:<span class="Constant">004014B9</span> <span class="Identifier">cmp</span> <span class="Identifier">ebx</span>, <span class="Constant">43</span><span class="Identifier">h</span>
<span class="Statement">.text</span>:<span class="Constant">004014BC</span> <span class="Identifier">jnz</span> <span class="Identifier">short</span> <span class="Identifier">loc_4014B3</span>
<span class="Statement">.text</span>:<span class="Constant">004014BE</span> <span class="Identifier">push</span> <span class="Identifier">offset</span> <span class="Identifier">DllEntryPoint</span> <span class="Comment">; lpString</span>
<span class="Statement">.text</span>:<span class="Constant">004014C3</span> <span class="Identifier">call</span> <span class="Identifier">ds</span>:<span class="Identifier">lstrlenA</span>
<span class="Statement">.text</span>:<span class="Constant">004014C9</span> <span class="Identifier">mov</span> <span class="Identifier">ebx</span>, 0<span class="Identifier">FFFFFFh</span>
<span class="Statement">.text</span>:<span class="Constant">004014CE</span>
<span class="Statement">.text</span>:<span class="Constant">004014CE</span> <span class="Identifier">loc_4014CE</span>: <span class="Comment">; CODE XREF: DllEntryPoint+2Cj</span>
<span class="Statement">.text</span>:<span class="Constant">004014CE</span> <span class="Identifier">nop</span>
<span class="Statement">.text</span>:<span class="Constant">004014CF</span> <span class="Identifier">nop</span>
<span class="Statement">.text</span>:<span class="Constant">004014D0</span> <span class="Identifier">nop</span>
<span class="Statement">.text</span>:<span class="Constant">004014D1</span> <span class="Identifier">nop</span>
<span class="Statement">.text</span>:<span class="Constant">004014D2</span> <span class="Identifier">nop</span>
<span class="Statement">.text</span>:<span class="Constant">004014D3</span> <span class="Identifier">dec</span> <span class="Identifier">ebx</span>
<span class="Statement">.text</span>:<span class="Constant">004014D4</span> <span class="Identifier">cmp</span> <span class="Identifier">ebx</span>, <span class="Constant">43</span><span class="Identifier">h</span>
<span class="Statement">.text</span>:<span class="Constant">004014D7</span> <span class="Identifier">jnz</span> <span class="Identifier">short</span> <span class="Identifier">loc_4014CE</span>
<span class="Statement">.text</span>:<span class="Constant">004014D9</span> <span class="Identifier">push</span> <span class="Constant">40</span><span class="Identifier">h</span> <span class="Comment">; flProtect</span>
<span class="Statement">.text</span>:<span class="Constant">004014DB</span> <span class="Identifier">push</span> <span class="Constant">3000</span><span class="Identifier">h</span> <span class="Comment">; flAllocationType</span>
<span class="Statement">.text</span>:<span class="Constant">004014E0</span> <span class="Identifier">push</span> <span class="Constant">30</span><span class="Identifier">AD8h</span> <span class="Comment">; dwSize</span>
<span class="Statement">.text</span>:<span class="Constant">004014E5</span> <span class="Identifier">push</span> <span class="Constant">0 </span><span class="Comment">; lpAddress</span>
<span class="Statement">.text</span>:<span class="Constant">004014E7</span> <span class="Identifier">call</span> <span class="Identifier">ds</span>:<span class="Identifier">VirtualAlloc</span>
<span class="Statement">.text</span>:<span class="Constant">004014ED</span> <span class="Identifier">mov</span> <span class="Identifier">edx</span>, <span class="Identifier">eax</span>
<span class="Statement">.text</span>:<span class="Constant">004014EF</span> <span class="Identifier">mov</span> <span class="Identifier">edi</span>, <span class="Identifier">eax</span>
<span class="Statement">.text</span>:<span class="Constant">004014F1</span> <span class="Identifier">mov</span> <span class="Identifier">esi</span>, <span class="Identifier">offset</span> <span class="Identifier">byte_401549</span>
<span class="Statement">.text</span>:<span class="Constant">004014F6</span>
<span class="Statement">.text</span>:<span class="Constant">004014F6</span> <span class="Identifier">loc_4014F6</span>: <span class="Comment">; CODE XREF: DllEntryPoint:loc_401518j</span>
<span class="Statement">.text</span>:<span class="Constant">004014F6</span> <span class="Identifier">call</span> <span class="Identifier">sub_401520</span>
<span class="Statement">.text</span>:<span class="Constant">004014FB</span> <span class="Identifier">shl</span> <span class="Identifier">al</span>, <span class="Constant">2</span>
<span class="Statement">.text</span>:<span class="Constant">004014FE</span> <span class="Identifier">shr</span> <span class="Identifier">ax</span>, <span class="Constant">2</span>
<span class="Statement">.text</span>:<span class="Constant">00401502</span> <span class="Identifier">stosb</span>
<span class="Statement">.text</span>:<span class="Constant">00401503</span> <span class="Identifier">shl</span> <span class="Identifier">ah</span>, <span class="Constant">4</span>
<span class="Statement">.text</span>:<span class="Constant">00401506</span> <span class="Identifier">shr</span> <span class="Identifier">eax</span>, <span class="Constant">8</span>
<span class="Statement">.text</span>:<span class="Constant">00401509</span> <span class="Identifier">shl</span> <span class="Identifier">ax</span>, <span class="Constant">2</span>
<span class="Statement">.text</span>:<span class="Constant">0040150D</span> <span class="Identifier">shr</span> <span class="Identifier">eax</span>, <span class="Constant">6</span>
<span class="Statement">.text</span>:<span class="Constant">00401510</span> <span class="Identifier">stosw</span>
<span class="Statement">.text</span>:<span class="Constant">00401512</span> <span class="Identifier">cmp</span> <span class="Identifier">esi</span>, <span class="Identifier">offset</span> <span class="Identifier">byte_43201D</span>
<span class="Statement">.text</span>:<span class="Constant">00401518</span>
<span class="Statement">.text</span>:<span class="Constant">00401518</span> <span class="Identifier">loc_401518</span>: <span class="Comment">; CODE XREF: .text:00401556j</span>
<span class="Statement">.text</span>:<span class="Constant">00401518</span> <span class="Identifier">jbe</span> <span class="Identifier">short</span> <span class="Identifier">loc_4014F6</span>
<span class="Statement">.text</span>:<span class="Constant">0040151A</span> <span class="Identifier">pop</span> <span class="Identifier">ebx</span>
<span class="Statement">.text</span>:<span class="Constant">0040151B</span> <span class="Identifier">pop</span> <span class="Identifier">edi</span>
<span class="Statement">.text</span>:<span class="Constant">0040151C</span> <span class="Identifier">pop</span> <span class="Identifier">esi</span>
<span class="Statement">.text</span>:<span class="Constant">0040151D</span> <span class="Identifier">int</span> <span class="Constant">3</span> <span class="Comment">; - software interrupt to invoke the debugger</span>
<span class="Statement">.text</span>:<span class="Constant">0040151F</span> <span class="Identifier">retn</span>
<span class="Statement">.text</span>:<span class="Constant">0040151F</span> <span class="Identifier">DllEntryPoint</span> <span class="Identifier">endp</span>
</pre>

Awesome! Now let's write a quick app to run it:

<pre>
<span class="PreProc">#include </span><span class="Constant">&lt;windows.h&gt;</span>

<span class="Type">int</span> main(<span class="Type">int</span> argc, <span class="Type">char</span> *argv[])
{
        LoadLibrary(<span class="Constant">&quot;C:</span><span class="Special">\\</span><span class="Constant">Documents and Settings</span><span class="Special">\\</span><span class="Constant">Administrator</span><span class="Special">\\</span><span class="Constant">Desktop</span><span class="Special">\\</span><span class="Constant">sample_safe.bin&quot;</span>);

        <span class="Statement">return</span> <span class="Constant">0</span>;
}
</pre>

And compile it, then run it in a debugger (I'm going to use windbg, since that's my favourite debugger):

<pre>
<span class="Statement">C</span>:<span class="Error">\</span>Program Files<span class="Error">\</span>Debugging Tools <span class="Statement">for</span> Windows (x86)&gt;windbg <span class="Constant">'</span><span class="Error">c:\Documents and Settings\Administrator\My Documents\Visual Studio 2008\Projects</span><span class="Special">\t</span><span class="Error">est_malware\Debug</span><span class="Special">\t</span><span class="Error">est_malware.exe</span><span class="Constant">'</span>

Executable search path is:
<span class="Statement">ModLoad</span>: <span class="Constant">00400000</span> 0041b000 test_malware.exe
<span class="Statement">ModLoad</span>: 7c800000 7c8c0000 ntdll.dll
<span class="Statement">ModLoad</span>: <span class="Constant">77e40000</span> 77f42000 C:<span class="Error">\</span>WINDOWS<span class="Error">\</span>system32<span class="Error">\</span>kernel32.dll
<span class="Statement">ModLoad</span>: <span class="Constant">10200000</span> <span class="Constant">10323000</span> C:<span class="Error">\</span>WINDOWS<span class="Error">\</span>WinSxS<span class="Error">\</span>x86_Microsoft.VC90.DebugCRT_1fc8b3b9a1e18e3b_9<span class="Constant">.0.21022.8</span>_x-ww_597C3456<span class="Error">\</span>MSVCR90D.dll
(1b8<span class="Constant">.2d</span>4): Break instruction exception - code <span class="Constant">80000003</span> (first chance)
eax=<span class="Constant">10400000</span> ebx=7ffda000 ecx=<span class="Constant">00000003</span> edx=<span class="Constant">00000008</span> esi=7c8877f4 edi=00151f38
eip=7c81a3e1 esp=0012fb70 ebp=0012fcb4 iopl=<span class="Constant">0</span> nv up ei pl nz na po nc
cs=001b ss=<span class="Constant">0023</span> ds=<span class="Constant">0023</span> es=<span class="Constant">0023</span> fs=003b gs=<span class="Constant">0000</span> efl=<span class="Constant">00000202</span>
*** ERROR: Symbol file could not be found. Defaulted to export symbols <span class="Statement">for</span> ntdll.dll -
ntdll!DbgBreakPoint:
7c81a3e1 cc <span class="Type">int</span> <span class="Constant">3</span>
<strong><span class="Constant">0</span>:<span class="Constant">000</span>&gt; g</strong>
<span class="Statement">ModLoad</span>: <span class="Constant">00350000</span> <span class="Constant">00389000</span> C:<span class="Error">\</span>Documents and Settings<span class="Error">\</span>Administrator<span class="Error">\</span>Desktop<span class="Error">\</span>sample_safe.bin
<span class="Statement">ModLoad</span>: <span class="Constant">77380000</span> <span class="Constant">77411000</span> C:<span class="Error">\</span>WINDOWS<span class="Error">\</span>system32<span class="Error">\</span>user32.dll
<span class="Statement">ModLoad</span>: 77c00000 77c48000 C:<span class="Error">\</span>WINDOWS<span class="Error">\</span>system32<span class="Error">\</span>GDI32.dll
<span class="Statement">ModLoad</span>: 77f50000 77feb000 C:<span class="Error">\</span>WINDOWS<span class="Error">\</span>system32<span class="Error">\</span>ADVAPI32.dll
<span class="Statement">ModLoad</span>: 77c50000 77cef000 C:<span class="Error">\</span>WINDOWS<span class="Error">\</span>system32<span class="Error">\</span>RPCRT4.dll
<span class="Statement">ModLoad</span>: 76f50000 76f63000 C:<span class="Error">\</span>WINDOWS<span class="Error">\</span>system32<span class="Error">\</span>Secur32.dll
(1b8<span class="Constant">.2d</span>4): Break instruction exception - code <span class="Constant">80000003</span> (first chance)
eax=<span class="Constant">00035000</span> ebx=003514ab ecx=<span class="Constant">77e64590</span> edx=003b0000 esi=0012f7d0 edi=<span class="Constant">00000001</span>
eip=0035151e esp=0012f7c0 ebp=0012f7dc iopl=<span class="Constant">0</span> nv up ei pl nz na po nc
cs=001b ss=<span class="Constant">0023</span> ds=<span class="Constant">0023</span> es=<span class="Constant">0023</span> fs=003b gs=<span class="Constant">0000</span> efl=<span class="Constant">00000202</span>
*** ERROR: Module load completed but symbols could not be loaded <span class="Statement">for</span> C:<span class="Error">\</span>Documents and Settings<span class="Error">\</span>Administrator<span class="Error">\</span>Desktop<span class="Error">\</span>sample_safe.bin
sample_safe+<span class="Constant">0x151e</span>:
0035151e 03c3 add eax,ebx
</pre>

Note that it hits a "break instruction"! Perfect!

We know that the original instruction was "jmp edx", and therefore the code is pointed at by edx. Sure enough, if we dump edx, we get something that looks like code:

<pre>
<strong><span class="Constant">0</span>:<span class="Constant">000</span>&gt; u edx</strong>
003b0000 <span class="Constant">55</span> <span class="Statement">push</span> ebp
003b0001 <span class="Constant">89e5</span> mov ebp,esp
003b0003 83ec04 <span class="Statement">sub </span><span class="Identifier">esp</span><span class="Error">,</span><span class="Constant">4</span>
003b0006 <span class="Constant">56</span> <span class="Statement">push</span> esi
003b0007 <span class="Constant">57</span> <span class="Statement">push</span> edi
003b0008 <span class="Constant">53</span> <span class="Statement">push</span> ebx
003b0009 e800000000 call 003b000e
003b000e 5b <span class="Statement">pop</span> ebx
</pre>

Perfect! We also know the length of the buffer, from the VirtualAlloc() call, so dump that many bytes to a file:

<pre>
<strong><span class="Constant">0</span>:<span class="Constant">000</span>&gt; .writemem c:<span class="Error">\\</span>stage2.bin <span class="Constant">0x3b0000</span> L0x30AD8</strong>
Writing 30ad8 bytes<span class="Identifier">................................................................................................</span><span class="Error">..</span>
</pre>

And open the file in IDA&mdash;yup, that's code!

And thus we're finished stage1. Congrats!

<h2>Stage2: going raw</h2>

If you load Stage2 in IDA, it's going to complain that it isn't actually a PE file&mdash;it's raw code. That's fine&mdash;load it as raw 32-bit code.

If you scroll around (you may need to use 'c' to mark stuff as code), you'll see a small amount of code (with interspersed strings), followed by another block that looks encrypted/obfuscated, including something that looks suspiciously&mdash;but not exactly&mdash;like part of a PE header:

<pre>
<span class="Identifier">seg000</span>:<span class="Constant">0000040</span><span class="Identifier">E</span>                 <span class="Identifier">db</span>  <span class="Constant">54</span><span class="Identifier">h</span> <span class="Comment">; T</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000040</span><span class="Identifier">F</span>                 <span class="Identifier">db</span>  <span class="Constant">68</span><span class="Identifier">h</span> <span class="Comment">; h</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000410</span>                 <span class="Identifier">db</span>  <span class="Constant">69</span><span class="Identifier">h</span> <span class="Comment">; i</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000411</span>                 <span class="Identifier">db</span>  <span class="Constant">73</span><span class="Identifier">h</span> <span class="Comment">; s</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000412</span>                 <span class="Identifier">db</span>  <span class="Constant">20</span><span class="Identifier">h</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000413</span>                 <span class="Identifier">db</span>  0<span class="Identifier">Eh</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000414</span>                 <span class="Identifier">db</span>  <span class="Constant">70</span><span class="Identifier">h</span> <span class="Comment">; p</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000415</span>                 <span class="Identifier">db</span>  <span class="Constant">72</span><span class="Identifier">h</span> <span class="Comment">; r</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000416</span>                 <span class="Identifier">db</span>  <span class="Constant">6</span><span class="Identifier">Fh</span> <span class="Comment">; o</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000417</span>                 <span class="Identifier">db</span>  <span class="Constant">67</span><span class="Identifier">h</span> <span class="Comment">; g</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000041</span><span class="Constant">8</span>                 <span class="Identifier">db</span>  <span class="Constant">67</span><span class="Identifier">h</span> <span class="Comment">; g</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000041</span><span class="Constant">9</span>                 <span class="Identifier">db</span>  <span class="Constant">61</span><span class="Identifier">h</span> <span class="Comment">; a</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000041</span><span class="Identifier">A</span>                 <span class="Identifier">db</span>  <span class="Constant">6</span><span class="Identifier">Dh</span> <span class="Comment">; m</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000041</span><span class="Identifier">B</span>                 <span class="Identifier">db</span>  <span class="Constant">87</span><span class="Identifier">h</span> <span class="Comment">; ç</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000041</span><span class="Identifier">C</span>                 <span class="Identifier">db</span>  <span class="Constant">63</span><span class="Identifier">h</span> <span class="Comment">; c</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000041</span><span class="Identifier">D</span>                 <span class="Identifier">db</span>  <span class="Constant">47</span><span class="Identifier">h</span> <span class="Comment">; G</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000041</span><span class="Identifier">E</span>                 <span class="Identifier">db</span>  <span class="Constant">6</span><span class="Identifier">Eh</span> <span class="Comment">; n</span>
</pre>

Well, time to start all over!

By now, you know that my usual strategy is to let the program own itself, rather than spending a lot of time owning it. As a result, I don't really know how the obfuscation works; I just know how to bypass it!

If you're following along, I'm not going to be a ton of help on how to get the function readable. It's a mixture of "c" (for "code" sections), and "u" (to undefine non-code portions). After you see a short "call" that jumps over some weird looking code, that code probably needs to be undefined (or defined as an "a"scii string).

If you do everything right, it should wind up looking like this:

<pre>
<span class="Identifier">seg000</span>:<span class="Constant">00000000</span>                 <span class="Identifier">push</span>    <span class="Identifier">ebp</span>             <span class="Comment">; Standard function prefix</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000001</span>                 <span class="Identifier">mov</span>     <span class="Identifier">ebp</span>, <span class="Identifier">esp</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000003</span>                 <span class="Identifier">sub</span>     <span class="Identifier">esp</span>, <span class="Constant">4</span>          <span class="Comment">; 4 bytes for local variables</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000006</span>                 <span class="Identifier">push</span>    <span class="Identifier">esi</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000007</span>                 <span class="Identifier">push</span>    <span class="Identifier">edi</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000008</span>                 <span class="Identifier">push</span>    <span class="Identifier">ebx</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000009</span>                 <span class="Identifier">call</span>    $+<span class="Constant">5</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000000E</span>                 <span class="Identifier">pop</span>     <span class="Identifier">ebx</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000000F</span>                 <span class="Identifier">sub</span>     <span class="Identifier">ebx</span>, <span class="Constant">40100</span><span class="Identifier">Eh</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000015</span>                 <span class="Identifier">mov</span>     <span class="Identifier">eax</span>, <span class="Identifier">dword</span> <span class="Identifier">ptr</span> <span class="Identifier">fs</span>:<span class="Identifier">loc_2C</span>+<span class="Constant">4</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000001B</span>                 <span class="Identifier">mov</span>     <span class="Identifier">eax</span>, [<span class="Identifier">eax</span>+0<span class="Identifier">Ch</span>]
<span class="Identifier">seg000</span>:<span class="Constant">0000001E</span>                 <span class="Identifier">mov</span>     <span class="Identifier">eax</span>, [<span class="Identifier">eax</span>+<span class="Constant">1</span><span class="Identifier">Ch</span>]
<span class="Identifier">seg000</span>:<span class="Constant">00000021</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000021</span> <span class="Identifier">loc_21</span>:                                 <span class="Comment">; CODE XREF: seg000:0000002Aj</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000021</span>                 <span class="Identifier">mov</span>     <span class="Identifier">esi</span>, [<span class="Identifier">eax</span>+<span class="Constant">8</span>]
<span class="Identifier">seg000</span>:<span class="Constant">00000024</span>                 <span class="Identifier">cmp</span>     <span class="Identifier">byte</span> <span class="Identifier">ptr</span> [<span class="Identifier">eax</span>+<span class="Constant">1</span><span class="Identifier">Ch</span>], <span class="Constant">18</span><span class="Identifier">h</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000028</span>                 <span class="Identifier">mov</span>     <span class="Identifier">eax</span>, [<span class="Identifier">eax</span>]
<span class="Identifier">seg000</span>:<span class="Constant">0000002A</span>                 <span class="Identifier">jnz</span>     <span class="Identifier">short</span> <span class="Identifier">loc_21</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000002C</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000002C</span> <span class="Identifier">loc_2C</span>:                                 <span class="Comment">; DATA XREF: seg000:00000015r</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000002C</span>                                         <span class="Comment">; sub_2E5+4:r</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000002C</span>                 <span class="Identifier">call</span>    <span class="Identifier">loc_40</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000002C</span> <span class="Comment">; ---------------------------------------------------------------------------</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000031</span> <span class="Identifier">aGetProcAddress</span> <span class="Identifier">db</span> '<span class="Identifier">GetProcAddress</span>',<span class="Constant">0</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000040</span> <span class="Comment">; ---------------------------------------------------------------------------</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000040</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000040</span> <span class="Identifier">loc_40</span>:                                 <span class="Comment">; CODE XREF: seg000:loc_2Cp</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000040</span>                 <span class="Identifier">push</span>    <span class="Identifier">esi</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000041</span>                 <span class="Identifier">call</span>    <span class="Identifier">sub_188</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000046</span>                 <span class="Identifier">mov</span>     [<span class="Identifier">ebx</span>+<span class="Constant">4013</span><span class="Identifier">BCh</span>], <span class="Identifier">eax</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000004C</span>                 <span class="Identifier">call</span>    <span class="Identifier">loc_5E</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000004C</span> <span class="Comment">; ---------------------------------------------------------------------------</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000051</span> <span class="Identifier">aLoadlibrarya</span>   <span class="Identifier">db</span> '<span class="Identifier">LoadLibraryA</span>',<span class="Constant">0</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000005E</span> <span class="Comment">; ---------------------------------------------------------------------------</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000005E</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000005E</span> <span class="Identifier">loc_5E</span>:                                 <span class="Comment">; CODE XREF: seg000:0000004Cp</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000005E</span>                 <span class="Identifier">push</span>    <span class="Identifier">esi</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000005F</span>                 <span class="Identifier">call</span>    <span class="Identifier">dword</span> <span class="Identifier">ptr</span> [<span class="Identifier">ebx</span>+<span class="Constant">4013</span><span class="Identifier">BCh</span>]
<span class="Identifier">seg000</span>:<span class="Constant">00000065</span>                 <span class="Identifier">mov</span>     [<span class="Identifier">ebx</span>+<span class="Constant">4013</span><span class="Identifier">C0h</span>], <span class="Identifier">eax</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000006B</span>                 <span class="Identifier">call</span>    <span class="Identifier">loc_80</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000006B</span> <span class="Comment">; ---------------------------------------------------------------------------</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000070</span> <span class="Identifier">aUnmapviewoffile</span> <span class="Identifier">db</span> '<span class="Identifier">UnmapViewOfFile</span>',<span class="Constant">0</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000080</span> <span class="Comment">; ---------------------------------------------------------------------------</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000080</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000080</span> <span class="Identifier">loc_80</span>:                                 <span class="Comment">; CODE XREF: seg000:0000006Bp</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000080</span>                 <span class="Identifier">push</span>    <span class="Identifier">esi</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000081</span>                 <span class="Identifier">call</span>    <span class="Identifier">dword</span> <span class="Identifier">ptr</span> [<span class="Identifier">ebx</span>+<span class="Constant">4013</span><span class="Identifier">BCh</span>]
<span class="Identifier">seg000</span>:<span class="Constant">00000087</span>                 <span class="Identifier">mov</span>     [<span class="Identifier">ebx</span>+<span class="Constant">4013</span><span class="Identifier">C4h</span>], <span class="Identifier">eax</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000008D</span>                 <span class="Identifier">call</span>    <span class="Identifier">loc_9F</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000008D</span> <span class="Comment">; ---------------------------------------------------------------------------</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000092</span> <span class="Identifier">aVirtualalloc</span>   <span class="Identifier">db</span> '<span class="Identifier">VirtualAlloc</span>',<span class="Constant">0</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000009F</span> <span class="Comment">; ---------------------------------------------------------------------------</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000009F</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000009F</span> <span class="Identifier">loc_9F</span>:                                 <span class="Comment">; CODE XREF: seg000:0000008Dp</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000009F</span>                 <span class="Identifier">push</span>    <span class="Identifier">esi</span>
<span class="Identifier">seg000</span>:<span class="Constant">000000A0</span>                 <span class="Identifier">call</span>    <span class="Identifier">dword</span> <span class="Identifier">ptr</span> [<span class="Identifier">ebx</span>+<span class="Constant">4013</span><span class="Identifier">BCh</span>]
<span class="Identifier">seg000</span>:<span class="Constant">000000A6</span>                 <span class="Identifier">mov</span>     [<span class="Identifier">ebx</span>+<span class="Constant">4013</span><span class="Identifier">C8h</span>], <span class="Identifier">eax</span>
<span class="Identifier">seg000</span>:<span class="Constant">000000AC</span>                 <span class="Identifier">call</span>    <span class="Identifier">loc_BD</span>
<span class="Identifier">seg000</span>:<span class="Constant">000000AC</span> <span class="Comment">; ---------------------------------------------------------------------------</span>
<span class="Identifier">seg000</span>:<span class="Constant">000000B1</span> <span class="Identifier">aVirtualfree</span>    <span class="Identifier">db</span> '<span class="Identifier">VirtualFree</span>',<span class="Constant">0</span>
<span class="Identifier">seg000</span>:<span class="Constant">000000BD</span> <span class="Comment">; ---------------------------------------------------------------------------</span>
<span class="Identifier">seg000</span>:<span class="Constant">000000BD</span>
<span class="Identifier">seg000</span>:<span class="Constant">000000BD</span> <span class="Identifier">loc_BD</span>:                                 <span class="Comment">; CODE XREF: seg000:000000ACp</span>
<span class="Identifier">seg000</span>:<span class="Constant">000000BD</span>                 <span class="Identifier">push</span>    <span class="Identifier">esi</span>
<span class="Identifier">seg000</span>:<span class="Constant">000000BE</span>                 <span class="Identifier">call</span>    <span class="Identifier">dword</span> <span class="Identifier">ptr</span> [<span class="Identifier">ebx</span>+<span class="Constant">4013</span><span class="Identifier">BCh</span>]
<span class="Identifier">seg000</span>:<span class="Constant">000000C4</span>                 <span class="Identifier">mov</span>     [<span class="Identifier">ebx</span>+<span class="Constant">4013</span><span class="Identifier">CCh</span>], <span class="Identifier">eax</span>
<span class="Identifier">seg000</span>:<span class="Constant">000000CA</span>
<span class="Identifier">seg000</span>:<span class="Constant">000000CA</span> <span class="Identifier">loc_CA</span>:                                 <span class="Comment">; CODE XREF: seg000:000000E0j</span>
<span class="Identifier">seg000</span>:<span class="Constant">000000CA</span>                 <span class="Identifier">push</span>    <span class="Constant">4</span>
<span class="Identifier">seg000</span>:<span class="Constant">000000CC</span>                 <span class="Identifier">push</span>    <span class="Constant">3000</span><span class="Identifier">h</span>
<span class="Identifier">seg000</span>:<span class="Constant">000000D1</span>                 <span class="Identifier">push</span>    0<span class="Identifier">A00000h</span>
<span class="Identifier">seg000</span>:<span class="Constant">000000D6</span>                 <span class="Identifier">push</span>    <span class="Constant">0</span>
<span class="Identifier">seg000</span>:<span class="Constant">000000D8</span>                 <span class="Identifier">call</span>    <span class="Identifier">dword</span> <span class="Identifier">ptr</span> [<span class="Identifier">ebx</span>+<span class="Constant">4013</span><span class="Identifier">C8h</span>]
<span class="Identifier">seg000</span>:<span class="Constant">000000DE</span>                 <span class="Identifier">test</span>    <span class="Identifier">eax</span>, <span class="Identifier">eax</span>
<span class="Identifier">seg000</span>:<span class="Constant">000000E0</span>                 <span class="Identifier">jz</span>      <span class="Identifier">short</span> <span class="Identifier">loc_CA</span>
<span class="Identifier">seg000</span>:<span class="Constant">000000E2</span>                 <span class="Identifier">mov</span>     [<span class="Identifier">ebp</span>-<span class="Constant">4</span>], <span class="Identifier">eax</span>
<span class="Identifier">seg000</span>:<span class="Constant">000000E5</span>                 <span class="Identifier">push</span>    <span class="Identifier">eax</span>
<span class="Identifier">seg000</span>:<span class="Constant">000000E6</span>                 <span class="Identifier">lea</span>     <span class="Identifier">eax</span>, [<span class="Identifier">ebx</span>+<span class="Constant">4013</span><span class="Identifier">D0h</span>]
<span class="Identifier">seg000</span>:<span class="Constant">000000EC</span>                 <span class="Identifier">mov</span>     <span class="Identifier">ecx</span>, [<span class="Identifier">eax</span>+<span class="Constant">4</span>]
<span class="Identifier">seg000</span>:<span class="Constant">000000EF</span>                 <span class="Identifier">add</span>     <span class="Identifier">eax</span>, <span class="Identifier">ecx</span>
<span class="Identifier">seg000</span>:<span class="Constant">000000F1</span>                 <span class="Identifier">push</span>    <span class="Identifier">eax</span>
<span class="Identifier">seg000</span>:<span class="Constant">000000F2</span>                 <span class="Identifier">call</span>    <span class="Identifier">sub_313</span>
<span class="Identifier">seg000</span>:<span class="Constant">000000F7</span>                 <span class="Identifier">pop</span>     <span class="Identifier">eax</span>
<span class="Identifier">seg000</span>:<span class="Constant">000000F8</span>                 <span class="Identifier">pop</span>     <span class="Identifier">eax</span>
<span class="Identifier">seg000</span>:<span class="Constant">000000F9</span>                 <span class="Identifier">mov</span>     <span class="Identifier">esi</span>, [<span class="Identifier">ebp</span>-<span class="Constant">4</span>]
<span class="Identifier">seg000</span>:<span class="Constant">000000FC</span>                 <span class="Identifier">add</span>     <span class="Identifier">esi</span>, [<span class="Identifier">esi</span>+<span class="Constant">3</span><span class="Identifier">Ch</span>]
<span class="Identifier">seg000</span>:<span class="Constant">000000FF</span>                 <span class="Identifier">mov</span>     <span class="Identifier">edi</span>, [<span class="Identifier">esi</span>+<span class="Constant">34</span><span class="Identifier">h</span>]
<span class="Identifier">seg000</span>:<span class="Constant">00000102</span>                 <span class="Identifier">mov</span>     <span class="Identifier">eax</span>, [<span class="Identifier">ebp</span>+<span class="Constant">10</span><span class="Identifier">h</span>]
<span class="Identifier">seg000</span>:<span class="Constant">00000105</span>                 <span class="Identifier">test</span>    <span class="Identifier">eax</span>, <span class="Identifier">eax</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000107</span>                 <span class="Identifier">jnz</span>     <span class="Identifier">short</span> <span class="Identifier">loc_114</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000109</span>                 <span class="Identifier">mov</span>     <span class="Identifier">eax</span>, [<span class="Identifier">ebp</span>+0<span class="Identifier">Ch</span>]
<span class="Identifier">seg000</span>:<span class="Constant">0000010C</span>                 <span class="Identifier">dec</span>     <span class="Identifier">eax</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000010D</span>                 <span class="Identifier">test</span>    <span class="Identifier">eax</span>, <span class="Identifier">eax</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000010F</span>                 <span class="Identifier">jnz</span>     <span class="Identifier">short</span> <span class="Identifier">loc_114</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000111</span>                 <span class="Identifier">mov</span>     <span class="Identifier">edi</span>, [<span class="Identifier">ebp</span>+<span class="Constant">8</span>]
<span class="Identifier">seg000</span>:<span class="Constant">00000114</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000114</span> <span class="Identifier">loc_114</span>:                                <span class="Comment">; CODE XREF: seg000:00000107j</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000114</span>                                         <span class="Comment">; seg000:0000010Fj</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000114</span>                 <span class="Identifier">push</span>    <span class="Identifier">edi</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000115</span>                 <span class="Identifier">call</span>    <span class="Identifier">dword</span> <span class="Identifier">ptr</span> [<span class="Identifier">ebx</span>+<span class="Constant">4013</span><span class="Identifier">C4h</span>]
<span class="Identifier">seg000</span>:<span class="Constant">0000011B</span>                 <span class="Identifier">mov</span>     <span class="Identifier">eax</span>, [<span class="Identifier">esi</span>+<span class="Constant">50</span><span class="Identifier">h</span>]
<span class="Identifier">seg000</span>:<span class="Constant">0000011E</span>                 <span class="Identifier">push</span>    <span class="Constant">40</span><span class="Identifier">h</span> <span class="Comment">; '@'</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000120</span>                 <span class="Identifier">push</span>    <span class="Constant">3000</span><span class="Identifier">h</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000125</span>                 <span class="Identifier">push</span>    <span class="Identifier">eax</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000126</span>                 <span class="Identifier">push</span>    <span class="Identifier">edi</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000127</span>                 <span class="Identifier">call</span>    <span class="Identifier">dword</span> <span class="Identifier">ptr</span> [<span class="Identifier">ebx</span>+<span class="Constant">4013</span><span class="Identifier">C8h</span>]
<span class="Identifier">seg000</span>:<span class="Constant">0000012D</span>                 <span class="Identifier">mov</span>     <span class="Identifier">ecx</span>, [<span class="Identifier">esi</span>+<span class="Constant">54</span><span class="Identifier">h</span>]
<span class="Identifier">seg000</span>:<span class="Constant">00000130</span>                 <span class="Identifier">mov</span>     <span class="Identifier">esi</span>, [<span class="Identifier">ebp</span>-<span class="Constant">4</span>]
<span class="Identifier">seg000</span>:<span class="Constant">00000133</span>                 <span class="Identifier">rep</span> <span class="Identifier">movsb</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000135</span>                 <span class="Identifier">mov</span>     <span class="Identifier">edi</span>, <span class="Identifier">eax</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000137</span>                 <span class="Identifier">push</span>    <span class="Identifier">dword</span> <span class="Identifier">ptr</span> [<span class="Identifier">ebp</span>-<span class="Constant">4</span>]
<span class="Identifier">seg000</span>:<span class="Constant">0000013A</span>                 <span class="Identifier">push</span>    <span class="Identifier">edi</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000013B</span>                 <span class="Identifier">call</span>    <span class="Identifier">sub_1E9</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000140</span>                 <span class="Identifier">push</span>    <span class="Identifier">edi</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000141</span>                 <span class="Identifier">call</span>    <span class="Identifier">sub_219</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000146</span>                 <span class="Identifier">push</span>    <span class="Identifier">edi</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000147</span>                 <span class="Identifier">call</span>    <span class="Identifier">sub_28A</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000014C</span>                 <span class="Identifier">push</span>    <span class="Constant">8000</span><span class="Identifier">h</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000151</span>                 <span class="Identifier">push</span>    <span class="Constant">0</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000153</span>                 <span class="Identifier">push</span>    <span class="Identifier">dword</span> <span class="Identifier">ptr</span> [<span class="Identifier">ebp</span>-<span class="Constant">4</span>]
<span class="Identifier">seg000</span>:<span class="Constant">00000156</span>                 <span class="Identifier">call</span>    <span class="Identifier">dword</span> <span class="Identifier">ptr</span> [<span class="Identifier">ebx</span>+<span class="Constant">4013</span><span class="Identifier">CCh</span>]
<span class="Identifier">seg000</span>:<span class="Constant">0000015C</span>                 <span class="Identifier">mov</span>     <span class="Identifier">eax</span>, [<span class="Identifier">ebx</span>+<span class="Constant">4013</span><span class="Identifier">CCh</span>]
<span class="Identifier">seg000</span>:<span class="Constant">00000162</span>                 <span class="Identifier">lea</span>     <span class="Identifier">ecx</span>, [<span class="Identifier">ebx</span>+<span class="Constant">401000</span><span class="Identifier">h</span>]
<span class="Identifier">seg000</span>:<span class="Constant">00000168</span>                 <span class="Identifier">mov</span>     <span class="Identifier">edx</span>, [<span class="Identifier">edi</span>+<span class="Constant">3</span><span class="Identifier">Ch</span>]
<span class="Identifier">seg000</span>:<span class="Constant">0000016B</span>                 <span class="Identifier">add</span>     <span class="Identifier">edx</span>, <span class="Identifier">edi</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000016D</span>                 <span class="Identifier">mov</span>     <span class="Identifier">edx</span>, [<span class="Identifier">edx</span>+<span class="Constant">28</span><span class="Identifier">h</span>]
<span class="Identifier">seg000</span>:<span class="Constant">00000170</span>                 <span class="Identifier">add</span>     <span class="Identifier">edx</span>, <span class="Identifier">edi</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000172</span>                 <span class="Identifier">push</span>    <span class="Identifier">edx</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000173</span>                 <span class="Identifier">push</span>    <span class="Identifier">edi</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000174</span>                 <span class="Identifier">call</span>    <span class="Identifier">sub_2E5</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000179</span>                 <span class="Identifier">pop</span>     <span class="Identifier">ebx</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000017A</span>                 <span class="Identifier">pop</span>     <span class="Identifier">edi</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000017B</span>                 <span class="Identifier">pop</span>     <span class="Identifier">esi</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000017C</span>                 <span class="Identifier">leave</span>
<span class="Identifier">seg000</span>:<span class="Constant">0000017D</span>                 <span class="Identifier">push</span>    <span class="Constant">8000</span><span class="Identifier">h</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000182</span>                 <span class="Identifier">push</span>    <span class="Constant">0</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000184</span>                 <span class="Identifier">push</span>    <span class="Identifier">ecx</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000185</span>                 <span class="Identifier">push</span>    <span class="Identifier">edx</span>
<span class="Identifier">seg000</span>:<span class="Constant">00000186</span>                 <span class="Identifier">jmp</span>     <span class="Identifier">eax</span>
</pre>

One of the first things I recommend doing it to re-base the program (using edit->segments->rebase or something like that). I re-based to 0x3b0000, because that's the offset that was allocated by VirtualAlloc() on my system, and therefore is where the in-memory version ended up.

<h3>Some reversing</h3>

The first part took me some time to figure out:

<pre>
<span class="Identifier">seg000</span>:<span class="Constant">003B0015</span>                 <span class="Identifier">mov</span>     <span class="Identifier">eax</span>, <span class="Identifier">large</span> <span class="Identifier">fs</span>:<span class="Constant">30</span><span class="Identifier">h</span> <span class="Comment">; This section basically gets a handle to kernel32.dll</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B001B</span>                 <span class="Identifier">mov</span>     <span class="Identifier">eax</span>, [<span class="Identifier">eax</span>+0<span class="Identifier">Ch</span>]
<span class="Identifier">seg000</span>:<span class="Constant">003B001E</span>                 <span class="Identifier">mov</span>     <span class="Identifier">eax</span>, [<span class="Identifier">eax</span>+<span class="Constant">1</span><span class="Identifier">Ch</span>]
<span class="Identifier">seg000</span>:<span class="Constant">003B0021</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B0021</span> <span class="Identifier">loc_3B0021</span>:                             <span class="Comment">; CODE XREF: seg000:003B002Aj</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B0021</span>                 <span class="Identifier">mov</span>     <span class="Identifier">esi</span>, [<span class="Identifier">eax</span>+<span class="Constant">8</span>]
<span class="Identifier">seg000</span>:<span class="Constant">003B0024</span>                 <span class="Identifier">cmp</span>     <span class="Identifier">byte</span> <span class="Identifier">ptr</span> [<span class="Identifier">eax</span>+<span class="Constant">1</span><span class="Identifier">Ch</span>], <span class="Constant">18</span><span class="Identifier">h</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B0028</span>                 <span class="Identifier">mov</span>     <span class="Identifier">eax</span>, [<span class="Identifier">eax</span>]
<span class="Identifier">seg000</span>:<span class="Constant">003B002A</span>                 <span class="Identifier">jnz</span>     <span class="Identifier">short</span> <span class="Identifier">loc_3B0021</span> <span class="Comment">; When this ends, esi = handle to kernel32.dll</span>
</pre>

I actually googled parts of this, and eventually found an identical function online. Its purpose was to get a handle to the in-memory version of kernel32.dll. Sweet!

You'll then see this code:

<pre>
<span class="Identifier">seg000</span>:<span class="Constant">003B002C</span> <span class="Identifier">loc_3B002C</span>:
<span class="Identifier">seg000</span>:<span class="Constant">003B002C</span>                 <span class="Identifier">call</span>    <span class="Identifier">loc_3B0040</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B002C</span> <span class="Comment">; ---------------------------------------------------------------------------</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B0031</span> <span class="Identifier">aGetProcAddress</span> <span class="Identifier">db</span> '<span class="Identifier">GetProcAddress</span>',<span class="Constant">0</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B0040</span> <span class="Comment">; ---------------------------------------------------------------------------</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B0040</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B0040</span> <span class="Identifier">loc_3B0040</span>:                             <span class="Comment">; CODE XREF: seg000:loc_3B002Cp</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B0040</span>                 <span class="Identifier">push</span>    <span class="Identifier">esi</span>             <span class="Comment">; addr of kernel32.dll</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B0041</span>                 <span class="Identifier">call</span>    <span class="Identifier">find_function</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B0046</span>                 <span class="Identifier">mov</span>     [<span class="Identifier">ebx</span>+<span class="Identifier">test</span><span class="Statement">.addr</span><span class="Identifier">_GetProcAddress</span>], <span class="Identifier">eax</span>
</pre>

(Note that I defined a struct for test.addr_GetProcAddress&mdash;it involves generous use of the 'structs' tab in a way it was never intended to be used in IDA).

The find_function() function was actually a guess that turned out to be right. This sequence of code gets a handle to the GetProcAddress() function, and stores it on line 0x3b0046.

Then there are a bunch of sequences that basically look like:

<pre>
<span class="Identifier">seg000</span>:<span class="Constant">003B004C</span>                 <span class="Identifier">call</span>    <span class="Identifier">loc_3B005E</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B004C</span> <span class="Comment">; ---------------------------------------------------------------------------</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B0051</span> <span class="Identifier">aLoadlibrarya</span>   <span class="Identifier">db</span> '<span class="Identifier">LoadLibraryA</span>',<span class="Constant">0</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B005E</span> <span class="Comment">; ---------------------------------------------------------------------------</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B005E</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B005E</span> <span class="Identifier">loc_3B005E</span>:                             <span class="Comment">; CODE XREF: seg000:003B004Cp</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B005E</span>                 <span class="Identifier">push</span>    <span class="Identifier">esi</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B005F</span>                 <span class="Identifier">call</span>    [<span class="Identifier">ebx</span>+<span class="Identifier">test</span><span class="Statement">.addr</span><span class="Identifier">_GetProcAddress</span>]
<span class="Identifier">seg000</span>:<span class="Constant">003B0065</span>                 <span class="Identifier">mov</span>     [<span class="Identifier">ebx</span>+<span class="Identifier">test</span><span class="Statement">.addr</span><span class="Identifier">_LoadLibraryA</span>], <span class="Identifier">eax</span>
</pre>

Basically, it calls GetProcAddress() with "LoadLibraryA" as a parameter, and stores the result. It does this for a bunch of functions&mdash;basically, get pointers to a host of useful functions:

<ul>
<li>GetProcAddress</li>
<li>LoadLibraryA</li>
<li>UnmapViewOfFile</li>
<li>VirtualAlloc</li>
<li>VirtualFree</li>
</pre>

VirtualAlloc(), as you'll recall, was used in the last section to allocate space for decrypted memory. At this point, we can guess that it does the exact same thing again!

Sure enough, it allocates memory; but surprisingly, it's not executable! Here's the call:

<pre>
<span class="Identifier">seg000</span>:<span class="Constant">003B00CA</span> <span class="Identifier">loc_3B00CA</span>:                             <span class="Comment">; CODE XREF: seg000:003B00E0j</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B00CA</span>                 <span class="Identifier">push</span>    <span class="Constant">4</span>               <span class="Comment">; flProtect = PAGE_READWRITE</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B00CC</span>                 <span class="Identifier">push</span>    <span class="Constant">3000</span><span class="Identifier">h</span>           <span class="Comment">; flAllocationType = MEM_RESERVE | MEM_COMMIT</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B00D1</span>                 <span class="Identifier">push</span>    0<span class="Identifier">A00000h</span>        <span class="Comment">; dwSize = 10,485,760 bytes</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B00D6</span>                 <span class="Identifier">push</span>    <span class="Constant">0 </span>              <span class="Comment">; lpAddress</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B00D8</span>                 <span class="Identifier">call</span>    [<span class="Identifier">ebx</span>+<span class="Identifier">test</span><span class="Statement">.addr</span><span class="Identifier">_VirtualAlloc</span>]
<span class="Identifier">seg000</span>:<span class="Constant">003B00DE</span>                 <span class="Identifier">test</span>    <span class="Identifier">eax</span>, <span class="Identifier">eax</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B00E0</span>                 <span class="Identifier">jz</span>      <span class="Identifier">short</span> <span class="Identifier">loc_3B00CA</span>
</pre>

Note how it keeps attempting to allocate memory until it works. It's shit like this, malware...

Anyway, the memory is allocated!

Then a function is called:

<pre>
<span class="Identifier">seg000</span>:<span class="Constant">003B00E2</span>                 <span class="Identifier">mov</span>     [<span class="Identifier">ebp</span>-<span class="Constant">4</span>], <span class="Identifier">eax</span>    <span class="Comment">; ebp-4 = allocated memory</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B00E5</span>                 <span class="Identifier">push</span>    <span class="Identifier">eax</span>             <span class="Comment">; allocated memory</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B00E6</span>                 <span class="Identifier">lea</span>     <span class="Identifier">eax</span>, [<span class="Identifier">ebx</span>+<span class="Identifier">test</span><span class="Statement">.field</span><span class="Identifier">_4013D0</span>] <span class="Comment">; eax = ptr to encrypted data (003b03d0)</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B00EC</span>                 <span class="Identifier">mov</span>     <span class="Identifier">ecx</span>, [<span class="Identifier">eax</span>+<span class="Constant">4</span>]
<span class="Identifier">seg000</span>:<span class="Constant">003B00EF</span>                 <span class="Identifier">add</span>     <span class="Identifier">eax</span>, <span class="Identifier">ecx</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B00F1</span>                 <span class="Identifier">push</span>    <span class="Identifier">eax</span>             <span class="Comment">; Looks like start of obfuscated PE file (003b03e8)</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B00F2</span>                 <span class="Identifier">call</span>    <span class="Identifier">sub_3B0313</span>      <span class="Comment">; Complicated but looks harmless</span>
</pre>

The "encrypted data"&mdash;which, as we saw earlier, looks suspiciously like a PE file&mdash;is passed in, along with the allocated memory.

A fairly complex function is called, that I looked through but didn't reverse. It's complicated, but ultimately harmless.

<h3>Active analysis</h3>

With clever use of breakpoints and sweating bullets, I let that function run. If you're interested, this is how I did it: run sample_safe.bin in windbg; when the breakpoint fired, I moved eip to where the jump would have gone using "<tt>r eip=edx</tt>" in windbg; I set a breakpoint on line 0x3b00f7 using "<tt>bp 0x3b00f7</tt>"; I used "<tt>g</tt>" to continue the program; and bob's your uncle.

Running malware like this, once again, is *dangerous*! If you're following along, please be careful!

Anyway, once that function finishes, I check out the allocated memory:

<pre>
<span class="Identifier">0:000&gt; db 900000</span>
<span class="Constant">00900000</span>  <span class="Identifier">4d 5a 90 00 03 00 00 00-04 00 00 00 ff ff 00 00</span>  <span class="Constant">MZ..............</span>
<span class="Constant">00900010</span>  <span class="Identifier">b8 00 00 00 00 00 00 00-40 00 00 00 00 00 00 00</span>  <span class="Constant">........@.......</span>
<span class="Constant">00900020</span>  <span class="Identifier">00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00</span>  <span class="Constant">................</span>
<span class="Constant">00900030</span>  <span class="Identifier">00 00 00 00 00 00 00 00-00 00 00 00 e8 00 00 00</span>  <span class="Constant">................</span>
<span class="Constant">00900040</span>  <span class="Identifier">0e 1f ba 0e 00 b4 09 cd-21 b8 01 4c cd 21 54 68</span>  <span class="Constant">........!..L.!Th</span>
<span class="Constant">00900050</span>  <span class="Identifier">69 73 20 70 72 6f 67 72-61 6d 20 63 61 6e 6e 6f</span>  <span class="Constant">is program canno</span>
<span class="Constant">00900060</span>  <span class="Identifier">74 20 62 65 20 72 75 6e-20 69 6e 20 44 4f 53 20</span>  <span class="Constant">t be run in DOS </span>
<span class="Constant">00900070</span>  <span class="Identifier">6d 6f 64 65 2e 0d 0d 0a-24 00 00 00 00 00 00 00</span>  <span class="Constant">mode....$.......</span>
</pre>

It's a PE file! w00t!

So thinking that's a length might just be right! I dump the file to see if IDA recognizes it:
<pre>
<span class="Constant">0</span>:<span class="Constant">000</span>&gt; .writemem <span class="Constant">&quot;c:</span><span class="Special">\\</span><span class="Constant">stage3.bin&quot;</span> <span class="Constant">0x900000</span> L0x00020a00
Writing 20a00 bytes<span class="Identifier">..................................................................</span>
</pre>

Read it with IDA, and confirm that it's a valid PE.

But... there's more code after the PE is decrypted. What's going on?

<h3>Going above and beyond in stage2</h3>

So, this part is strictly unnecessary to figuring out how the malware works. I was simply curious, and wanted to make sure that nothing weird was going on.

Some variables are moved around after the decryption, but at this point I'm carefully stepping through with a debugger. I find this code:

<pre>
<span class="Identifier">seg000</span>:<span class="Constant">003B0114</span>                 <span class="Identifier">push</span>    <span class="Identifier">edi</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B0115</span>                 <span class="Identifier">call</span>    [<span class="Identifier">ebx</span>+<span class="Identifier">test</span><span class="Statement">.addr</span><span class="Identifier">_UnmapViewOfFile</span>]
</pre>

And determine that edi is pointing to stage1. So, stage1 is unloaded.

Then, some executable memory is allocated:

<pre>
<span class="Identifier">seg000</span>:<span class="Constant">003B011E</span>                 <span class="Identifier">push</span>    <span class="Constant">40</span><span class="Identifier">h</span> <span class="Comment">; '@'       ; flProtect = PAGE_EXECUTE_READWRITE</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B0120</span>                 <span class="Identifier">push</span>    <span class="Constant">3000</span><span class="Identifier">h</span>           <span class="Comment">; flAlloctionType = MEM_COMMIT | MEM_RESERVE</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B0125</span>                 <span class="Identifier">push</span>    <span class="Identifier">eax</span>             <span class="Comment">; dwSize = a bit bigger than the decrypt function returned</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B0126</span>                 <span class="Identifier">push</span>    <span class="Identifier">edi</span>             <span class="Comment">; lpAddress = the same address that the .dll was unloaded from</span>
<span class="Identifier">seg000</span>:<span class="Constant">003B0127</span>                 <span class="Identifier">call</span>    [<span class="Identifier">ebx</span>+<span class="Identifier">test</span><span class="Statement">.addr</span><span class="Identifier">_VirtualAlloc</span>]
</pre>

Some incredibly complicated functions are called. I surmised&mdash;correctly&mdash;that these are taking the PE file in memory&mdash;that we just decrypted&mdash;and preparing it to be run. Basically, do the relocations and other stuff that is involved with making a PE file actually runnable. 

Then, the decrypted PE file&mdash;the version that came before it was actually relocated, that it just finished relocating&mdash;is freed:

<pre>
<span class="Identifier">seg000</span>:<span class="Constant">003B0153</span>                 <span class="Identifier">push</span>    <span class="Identifier">dword</span> <span class="Identifier">ptr</span> [<span class="Identifier">ebp</span>-<span class="Constant">4</span>]
<span class="Identifier">seg000</span>:<span class="Constant">003B0156</span>                 <span class="Identifier">call</span>    [<span class="Identifier">ebx</span>+<span class="Identifier">test</span><span class="Statement">.addr</span><span class="Identifier">_VirtualFree</span>]
</pre>

Then finally, this sequence is found:

<pre>
<span class="Identifier">seg000</span>:<span class="Constant">003</span><span class="Identifier">B0174</span>                 <span class="Identifier">call</span>    <span class="Identifier">sub_3B02E5</span>
<span class="Identifier">seg000</span>:<span class="Constant">003</span><span class="Identifier">B0179</span>                 <span class="Identifier">pop</span>     <span class="Identifier">ebx</span>
<span class="Identifier">seg000</span>:<span class="Constant">003</span><span class="Identifier">B017A</span>                 <span class="Identifier">pop</span>     <span class="Identifier">edi</span>
<span class="Identifier">seg000</span>:<span class="Constant">003</span><span class="Identifier">B017B</span>                 <span class="Identifier">pop</span>     <span class="Identifier">esi</span>
<span class="Identifier">seg000</span>:<span class="Constant">003</span><span class="Identifier">B017C</span>                 <span class="Identifier">leave</span>
<span class="Identifier">seg000</span>:<span class="Constant">003</span><span class="Identifier">B017D</span>                 <span class="Identifier">push</span>    <span class="Constant">8000</span><span class="Identifier">h</span>
<span class="Identifier">seg000</span>:<span class="Constant">003</span><span class="Identifier">B0182</span>                 <span class="Identifier">push</span>    <span class="Constant">0</span>
<span class="Identifier">seg000</span>:<span class="Constant">003</span><span class="Identifier">B0184</span>                 <span class="Identifier">push</span>    <span class="Identifier">ecx</span>
<span class="Identifier">seg000</span>:<span class="Constant">003</span><span class="Identifier">B0185</span>                 <span class="Identifier">push</span>    <span class="Identifier">edx</span>
<span class="Identifier">seg000</span>:<span class="Constant">003</span><span class="Identifier">B0186</span>                 <span class="Identifier">jmp</span>     <span class="Identifier">eax</span>
</pre>

This is actually really cool. It calls sub_3b02e5, which returns a pointer to VirtualFree(). On line 0x3b0186, VirtualFree() is jumped to. That leads to two questions: why a jmp and not a call? And if VirtualFree() only takes a single argument, what's with all the other pushes?

Well, here's what's happening: a called function returns to whatever's on the top of the stack. If you jmp to a function that expects to be called, it returns to the last thing pushed onto the stack. Since that happens to be edx (pushed at 0x3b0185), that becomes the return address.

(edx happens to be the entrypoint of the new .dll file, stage3)

The next parameter above it&mdash;ecx, pushed at 0x3b0184&mdash;is the parameter to VirtualAlloc(). It's the starting address of the current code&mdash;0x3b0000. And finally, the other two arguments&mdash;0x0000 and 0x8000&mdash;are the arguments that the entrypoint of the .dll file expects to receive.

To summarize: this piece of code frees itself, then returns into the loaded .dll file. That's really cool!

Very little malware will actually clean up after itself like we see here. This tells me that the malware was written by somebody who actually cares about code quality. I'm impressed!

<h2>Stage3: The final frontier</h2>
Stage3 is actually pretty straight forward, although it does a lot of stuff that I haven't actually reversed. I've also made a lot of educated guesses on how it works that I've validated. If you're following along, this is in stage3.bin.

Essentially, it's a compressed payload stored in a PE resource. Let's look at what that means...

First off, look at the 'strings' window (shift-f12 in IDA). Looking at the strings window is almost always the first thing I do, with malware and also legit software. In this case, you'll see some interesting strings:

<pre>
<span class="Statement">.rdata</span>:<span class="Constant">100054A4</span> <span class="Identifier">aAplibV1_01TheS</span> <span class="Identifier">db</span> '<span class="Identifier">aPLib</span> <span class="Identifier">v1</span>.<span class="Constant">01 </span>- <span class="Identifier">the</span> <span class="Identifier">smaller</span> <span class="Identifier">the</span> <span class="Identifier">better</span> :)',0<span class="Identifier">Dh</span>,0<span class="Identifier">Ah</span>
<span class="Statement">.rdata</span>:<span class="Constant">100054A4</span> <span class="Identifier">db</span> '<span class="Identifier">Copyright</span> (<span class="Identifier">c</span>) <span class="Constant">1998</span>-<span class="Constant">2009</span> <span class="Identifier">by</span> <span class="Identifier">Joergen</span> <span class="Identifier">Ibsen</span>, <span class="Identifier">All</span> <span class="Identifier">Rights</span> <span class="Identifier">Reserved</span>.',0<span class="Identifier">Dh</span>,0<span class="Identifier">Ah</span>
<span class="Statement">.rdata</span>:<span class="Constant">100054A4</span> <span class="Identifier">db</span> 0<span class="Identifier">Dh</span>,0<span class="Identifier">Ah</span>
<span class="Statement">.rdata</span>:<span class="Constant">100054A4</span> <span class="Identifier">db</span> '<span class="Identifier">More</span> <span class="Identifier">information</span>: <span class="Identifier">http</span>://<span class="Identifier">www</span><span class="Statement">.ibsensoftware.com</span>/',0<span class="Identifier">Dh</span>,0<span class="Identifier">Ah</span>
<span class="Statement">.rdata</span>:<span class="Constant">100054A4</span> <span class="Identifier">db</span> 0<span class="Identifier">Dh</span>,0<span class="Identifier">Ah</span>,<span class="Constant">0</span>
</pre>

Immediately, I know it's using compression. That's handy! If you follow the DllEntryPoint() function to its calls, you'll quickly find this:

<pre>
<span class="Statement">.text</span>:<span class="Constant">10001C2E</span> <span class="Comment">; int __cdecl sub_10001C2E(HMODULE hModule, int)</span>
<span class="Statement">.text</span>:<span class="Constant">10001C2E</span> <span class="Identifier">sub_10001C2E</span> <span class="Identifier">proc</span> <span class="Identifier">near</span> <span class="Comment">; CODE XREF: do_stuff+12p</span>
<span class="Statement">.text</span>:<span class="Constant">10001C2E</span>
<span class="Statement">.text</span>:<span class="Constant">10001C2E</span> <span class="Identifier">hModule</span> = <span class="Identifier">dword</span> <span class="Identifier">ptr</span> <span class="Constant">8</span>
<span class="Statement">.text</span>:<span class="Constant">10001C2E</span> <span class="Identifier">arg_4</span> = <span class="Identifier">dword</span> <span class="Identifier">ptr</span> 0<span class="Identifier">Ch</span>
<span class="Statement">.text</span>:<span class="Constant">10001C2E</span>
<span class="Statement">.text</span>:<span class="Constant">10001C2E</span> <span class="Identifier">push</span> <span class="Identifier">ebp</span>
<span class="Statement">.text</span>:<span class="Constant">10001C2F</span> <span class="Identifier">mov</span> <span class="Identifier">ebp</span>, <span class="Identifier">esp</span>
<span class="Statement">.text</span>:<span class="Constant">10001C31</span> <span class="Identifier">push</span> <span class="Identifier">esi</span>
<span class="Statement">.text</span>:<span class="Constant">10001C32</span> <span class="Identifier">push</span> 0<span class="Identifier">Ah</span> <span class="Comment">; lpType</span>
<span class="Statement">.text</span>:<span class="Constant">10001C34</span> <span class="Identifier">push</span> <span class="Constant">65</span><span class="Identifier">h</span> <span class="Comment">; lpName</span>
<span class="Statement">.text</span>:<span class="Constant">10001C36</span> <span class="Identifier">push</span> [<span class="Identifier">ebp</span>+<span class="Identifier">hModule</span>] <span class="Comment">; hModule</span>
<span class="Statement">.text</span>:<span class="Constant">10001C39</span> <span class="Identifier">call</span> <span class="Identifier">ds</span>:<span class="Identifier">FindResourceA</span>
<span class="Statement">.text</span>:<span class="Constant">10001C3F</span> <span class="Identifier">mov</span> <span class="Identifier">esi</span>, <span class="Identifier">eax</span>
<span class="Statement">.text</span>:<span class="Constant">10001C41</span> <span class="Identifier">test</span> <span class="Identifier">esi</span>, <span class="Identifier">esi</span>
<span class="Statement">.text</span>:<span class="Constant">10001C43</span> <span class="Identifier">jz</span> <span class="Identifier">short</span> <span class="Identifier">loc_10001C9E</span>
<span class="Statement">.text</span>:<span class="Constant">10001C45</span> <span class="Identifier">push</span> <span class="Identifier">edi</span>
<span class="Statement">.text</span>:<span class="Constant">10001C46</span> <span class="Identifier">push</span> <span class="Identifier">esi</span> <span class="Comment">; hResInfo</span>
<span class="Statement">.text</span>:<span class="Constant">10001C47</span> <span class="Identifier">push</span> [<span class="Identifier">ebp</span>+<span class="Identifier">hModule</span>] <span class="Comment">; hModule</span>
<span class="Statement">.text</span>:<span class="Constant">10001C4A</span> <span class="Identifier">call</span> <span class="Identifier">ds</span>:<span class="Identifier">SizeofResource</span>
<span class="Statement">.text</span>:<span class="Constant">10001C50</span> <span class="Identifier">mov</span> <span class="Identifier">edi</span>, <span class="Identifier">eax</span>
<span class="Statement">.text</span>:<span class="Constant">10001C52</span> <span class="Identifier">test</span> <span class="Identifier">edi</span>, <span class="Identifier">edi</span>
<span class="Statement">.text</span>:<span class="Constant">10001C54</span> <span class="Identifier">jz</span> <span class="Identifier">short</span> <span class="Identifier">loc_10001C9D</span>
<span class="Statement">.text</span>:<span class="Constant">10001C56</span> <span class="Identifier">push</span> <span class="Identifier">ebx</span>
<span class="Statement">.text</span>:<span class="Constant">10001C57</span> <span class="Identifier">push</span> <span class="Identifier">esi</span> <span class="Comment">; hResInfo</span>
<span class="Statement">.text</span>:<span class="Constant">10001C58</span> <span class="Identifier">push</span> [<span class="Identifier">ebp</span>+<span class="Identifier">hModule</span>] <span class="Comment">; hModule</span>
<span class="Statement">.text</span>:<span class="Constant">10001C5B</span> <span class="Identifier">call</span> <span class="Identifier">ds</span>:<span class="Identifier">LoadResource</span>
<span class="Statement">.text</span>:<span class="Constant">10001C61</span> <span class="Identifier">mov</span> <span class="Identifier">ebx</span>, <span class="Identifier">eax</span>
<span class="Statement">.text</span>:<span class="Constant">10001C63</span> <span class="Identifier">test</span> <span class="Identifier">ebx</span>, <span class="Identifier">ebx</span>
<span class="Statement">.text</span>:<span class="Constant">10001C65</span> <span class="Identifier">jz</span> <span class="Identifier">short</span> <span class="Identifier">loc_10001C9C</span>
<span class="Statement">.text</span>:<span class="Constant">10001C67</span> <span class="Identifier">push</span> <span class="Identifier">ebx</span> <span class="Comment">; hResData</span>
<span class="Statement">.text</span>:<span class="Constant">10001C68</span> <span class="Identifier">call</span> <span class="Identifier">ds</span>:<span class="Identifier">LockResource</span>
<span class="Statement">.text</span>:<span class="Constant">10001C6E</span> <span class="Identifier">mov</span> <span class="Identifier">esi</span>, <span class="Identifier">eax</span>
<span class="Statement">.text</span>:<span class="Constant">10001C70</span> <span class="Identifier">test</span> <span class="Identifier">esi</span>, <span class="Identifier">esi</span>
<span class="Statement">.text</span>:<span class="Constant">10001C72</span> <span class="Identifier">jnz</span> <span class="Identifier">short</span> <span class="Identifier">loc_10001C78</span>
</pre>

Note the calls&mdash;FindResourceA(), SizeofResource(), LoadResource(), and LockResource(). If you're interested in what these are doing exactly, you can find plenty of info in MSDN. But suffice to say, it loads a resource from the PE, identified by the value passed into FindResourceA()&mdash;resource 0x65 (101). If you load a resource viewer&mdash;such as PEExplorer, you can view the resource section and dump resource 0x65 into a file. That file looks like:

<pre>
$ <span class="Identifier">xxd</span> -g1 <span class="Identifier">stage4_compressed</span>.<span class="Identifier">bin</span> | <span class="Identifier">head</span>
<span class="Identifier">0000000</span>: <span class="Identifier">41</span> <span class="Identifier">50</span> <span class="Identifier">33</span> <span class="Identifier">32</span> <span class="Identifier">18</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">a1</span> <span class="Identifier">c9</span> <span class="Identifier">01</span> <span class="Identifier">00</span> <span class="Identifier">0b</span> <span class="Identifier">e4</span> <span class="Identifier">d7</span> <span class="Identifier">66</span> <span class="Identifier">AP32</span>...........<span class="Identifier">f</span>
<span class="Identifier">0000010</span>: <span class="Identifier">0b</span> <span class="Identifier">51</span> <span class="Identifier">03</span> <span class="Identifier">00</span> <span class="Identifier">f2</span> <span class="Identifier">8d</span> <span class="Identifier">91</span> <span class="Identifier">b3</span> <span class="Identifier">0b</span> <span class="Identifier">38</span> <span class="Identifier">51</span> <span class="Identifier">03</span> <span class="Identifier">1c</span> <span class="Identifier">49</span> <span class="Identifier">01</span> <span class="Identifier">38</span> .<span class="Identifier">Q</span>.......<span class="Identifier">8Q</span>..<span class="Identifier">I</span>.<span class="Identifier">8</span>
<span class="Identifier">0000020</span>: <span class="Identifier">37</span> <span class="Identifier">b7</span> <span class="Identifier">0e</span> <span class="Identifier">0f</span> <span class="Identifier">8c</span> <span class="Identifier">07</span> <span class="Identifier">09</span> <span class="Identifier">7b</span> <span class="Identifier">d0</span> <span class="Identifier">1a</span> <span class="Identifier">01</span> <span class="Identifier">be</span> <span class="Identifier">bc</span> <span class="Identifier">55</span> <span class="Identifier">1c</span> <span class="Identifier">8b</span> <span class="Identifier">7</span>......<span class="Statement">{</span>.....<span class="Identifier">U</span>..
[...]
</pre>

The file starts with AP32, and earlier we saw a compression library called "aPLib" referenced. Compressed payload anyone?

As of the writing, you can download the official AP32 sample application <a href='http://ibsensoftware.com/files/aPLib-1.01.zip'>here</a>. You can unpack it with the appack.exe utility:

<pre>
$ ./appack.exe d ./stage4_compressed.bin stage4.bin
===============================================================================
aPLib example Copyright (c) 1998-2009 by <span class="Type">Joergen</span> <span class="Type">Ibsen</span> / <span class="Type">Jibz</span>
                                                            <span class="Type">All</span> <span class="Type">Rights</span> <span class="Type">Reserved</span>

                                                  http<span class="Constant">:/</span>/www.ibsensoftware.com/
===============================================================================

decompressed <span class="Constant">117177</span> -&gt; <span class="Constant">217355</span> bytes <span class="Statement">in</span> <span class="Constant">0.00</span> seconds
</pre>

(That tool is super buggy, you might have to move directories and stuff to get it to work; it's just a sample, after all)

<h3>Decompressed... now what?</h3>

Once decompressed, it looks like:

<pre>
<span class="Identifier">0000000</span>: <span class="Identifier">0b</span> <span class="Identifier">51</span> <span class="Identifier">03</span> <span class="Identifier">00</span> <span class="Identifier">49</span> <span class="Identifier">01</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">b7</span> <span class="Identifier">03</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">0b</span> <span class="Identifier">07</span> <span class="Identifier">00</span> <span class="Identifier">00</span> .Q..I...........
<span class="Identifier">0000010</span>: <span class="Identifier">0b</span> <span class="Identifier">7b</span> <span class="Identifier">01</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> .<span class="Statement">{</span>..............
<span class="Identifier">0000020</span>: <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> ................
<span class="Identifier">0000030</span>: <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> ................
<span class="Identifier">0000040</span>: <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> <span class="Identifier">00</span> ................
[...]
</pre>

Hmm.. it's clearly not compressed/encrypted, but it doesn't look like anything special.

If you scroll around, you'll quickly find a PE header. If you scroll down <em>a lot</em> more, you'll find another PE header. After looking at the numbers in the first 20 bytes, that they are offsets into the file as well as lengths. Those offsets represent PE files! Note that I haven't even *started* reversing the code that processes this&mdash;and I never did&mdash;I simply determined all this by simple guessing and checking.

Here are the first few int32 values (note: little endian), and what they seem to mean:

<ul>
  <li>0x0003510b - the length of the entire file</li>
  <li>0x00000149 - at this offset, there's some raw code&mdash;<tt>55 8b ...</tt> (a raw binary function)&mdash;I initially assumed a 16-bit version, but that doesn't seem likely</li>
  <li>0x000003b7 - at this offset, nothing special, but it appears to be code. Not sure what its deal is...</li>
  <li>0x0000070b - A proper PE file, that we're gonna call "stage4.bin"</li>
  <li>0x00017b0b - Another PE file&mdash;I guessed that this is a 64-bit version of the same thing, which seems likely&mdash;upon inspection, it has the same imports/strings</li>
  <li>0x00000000</li>
</ul>

I called the file at 0x70b the actual payload. There are also some loader functions and a 64-bit payload that I'm going to ignore.

<h3>Odds and ends of stage3</h3>

If you want to know more about stage3, keep reading! This section is very light&mdash;the code is complex, and doesn't really add much, so I'm going to give a quick high-level overview of it.

It actually creates a .dll file whose name is based on the harddrive serial number and an implementation of a standard pseudo-random number generator. This means that, if installed on the same machine, the .dll will have the same name.

It injects the .dll file into every running process, by the looks of it.

It puts a lot of effort into determining whether to use the 64- or 32-bit version for each running executable (including correctly detecting the use of Wow64).

Once again, because of the cleanness and the fact that it handles 32- and 64-bit systems, as well as Wow64 processes, appropriately, I feel like this was written by somebody who clearly knows what they are doing.

<h2>Conclusion</h2>

Once you extract the 32-bit .dll file from the de-compressed data, you now have what I called stage4.bin. This is the final stage, and does the actual malicious functionality. As I said initially, I haven't reversed it. But if you look at it in IDA, you'll see a ton of command-and-control-like functionality. It contacts servers over HTTPS, it modifies Web sites, and lots more interesting stuff.

When I have more time, I'll look at it in more detail!

Hope you enjoyed this!
